<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::title}, ~{::#content})}">
<head>
    <title th:text="${title}">Dashboard</title>
</head>
<body>
    <div id="content">
        <!-- Page Header -->
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">
                <i class="fas fa-tachometer-alt me-2"></i>
                Dashboard
            </h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <button class="btn btn-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt me-1"></i>
                    Làm mới
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-box fa-3x mb-3"></i>
                        <h3 id="total-products">-</h3>
                        <p class="mb-0">Tổng sản phẩm</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card success">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-3x mb-3"></i>
                        <h3 id="total-customers">-</h3>
                        <p class="mb-0">Khách hàng</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card warning">
                    <div class="card-body text-center">
                        <i class="fas fa-user-tie fa-3x mb-3"></i>
                        <h3 id="total-employees">-</h3>
                        <p class="mb-0">Nhân viên</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card danger">
                    <div class="card-body text-center">
                        <i class="fas fa-dollar-sign fa-3x mb-3"></i>
                        <h3 id="inventory-value">-</h3>
                        <p class="mb-0">Giá trị kho hàng</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Inventory Status Chart -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-pie me-2"></i>
                            Tình trạng kho hàng
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="inventoryChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Low Stock Products -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Sản phẩm sắp hết hàng
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="loading">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="low-stock-list">
                            <!-- Low stock products will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Recent Activities -->
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-clock me-2"></i>
                            Hoạt động gần đây
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Thời gian</th>
                                        <th>Hoạt động</th>
                                        <th>Chi tiết</th>
                                        <th>Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-activities">
                                    <tr>
                                        <td>Hôm nay, 10:30</td>
                                        <td>Thêm sản phẩm</td>
                                        <td>Đã thêm sản phẩm "Laptop Dell Inspiron"</td>
                                        <td><span class="badge bg-success">Thành công</span></td>
                                    </tr>
                                    <tr>
                                        <td>Hôm nay, 09:15</td>
                                        <td>Cập nhật khách hàng</td>
                                        <td>Cập nhật thông tin khách hàng "Nguyễn Văn A"</td>
                                        <td><span class="badge bg-success">Thành công</span></td>
                                    </tr>
                                    <tr>
                                        <td>Hôm qua, 16:45</td>
                                        <td>Thêm nhân viên</td>
                                        <td>Đã thêm nhân viên mới "Trần Thị B"</td>
                                        <td><span class="badge bg-success">Thành công</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let inventoryChart;

        // Load dashboard data
        async function loadDashboardData() {
            showLoading();
            
            try {
                // Load statistics
                const [productStats, customerStats, employeeStats] = await Promise.all([
                    API.get('/products/statistics'),
                    API.get('/customers/statistics'),
                    API.get('/employees/statistics')
                ]);

                // Update statistics cards
                if (productStats.success) {
                    document.getElementById('total-products').textContent = productStats.data.totalProducts || 0;
                    document.getElementById('inventory-value').textContent = 
                        formatCurrency(productStats.data.totalInventoryValue || 0);
                    
                    // Update inventory chart
                    updateInventoryChart(productStats.data);
                }

                if (customerStats.success) {
                    document.getElementById('total-customers').textContent = customerStats.data.totalCustomers || 0;
                }

                if (employeeStats.success) {
                    document.getElementById('total-employees').textContent = employeeStats.data.totalEmployees || 0;
                }

                // Load low stock products
                loadLowStockProducts();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('Lỗi khi tải dữ liệu dashboard', 'error');
            } finally {
                hideLoading();
            }
        }

        // Load low stock products
        async function loadLowStockProducts() {
            try {
                const response = await API.get('/products/low-stock?threshold=10');
                
                if (response.success) {
                    const lowStockList = document.getElementById('low-stock-list');
                    
                    if (response.data.length === 0) {
                        lowStockList.innerHTML = '<p class="text-muted">Không có sản phẩm nào sắp hết hàng</p>';
                    } else {
                        lowStockList.innerHTML = response.data.map(product => `
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                                <div>
                                    <strong>${product.productName}</strong>
                                    <small class="text-muted d-block">${product.category}</small>
                                </div>
                                <span class="badge bg-warning">Còn ${product.quantity}</span>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading low stock products:', error);
            }
        }

        // Update inventory chart
        function updateInventoryChart(data) {
            const ctx = document.getElementById('inventoryChart').getContext('2d');
            
            if (inventoryChart) {
                inventoryChart.destroy();
            }

            inventoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Còn hàng', 'Hết hàng', 'Sắp hết'],
                    datasets: [{
                        data: [
                            data.inStockCount || 0,
                            data.outOfStockCount || 0,
                            data.lowStockCount || 0
                        ],
                        backgroundColor: [
                            '#27ae60',
                            '#e74c3c', 
                            '#f39c12'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Refresh dashboard
        function refreshDashboard() {
            loadDashboardData();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            
            // Auto-refresh every 5 minutes
            setInterval(loadDashboardData, 300000);
        });
    </script>
</body>
</html>
