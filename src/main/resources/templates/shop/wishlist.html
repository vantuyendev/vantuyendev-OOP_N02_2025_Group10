<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Danh Sách Yêu Thích - Quản Lý Cửa Hàng</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- External CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        
        .main-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px 0;
            color: white;
        }
        
        .wishlist-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .wishlist-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .product-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
        }
        
        .product-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .product-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .product-category {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .btn-wishlist {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-wishlist:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
        }
        
        .btn-remove {
            background: #dc3545;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-remove:hover {
            background: #c82333;
            color: white;
        }
        
        .empty-wishlist {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }
        
        .empty-wishlist i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.7;
        }
        
        .wishlist-stats {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            color: white;
        }
        
        .stock-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 15px;
        }
        
        .in-stock {
            background: #28a745;
            color: white;
        }
        
        .out-stock {
            background: #dc3545;
            color: white;
        }
        
        .low-stock {
            background: #ffc107;
            color: #212529;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="main-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-auto">
                    <h2 class="mb-0">
                        <i class="bi bi-heart-fill me-2"></i>
                        Danh Sách Yêu Thích
                    </h2>
                </div>
                <div class="col">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item">
                                <a href="/shop/dashboard" class="text-white-50">Dashboard</a>
                            </li>
                            <li class="breadcrumb-item active text-white" aria-current="page">
                                Yêu Thích
                            </li>
                        </ol>
                    </nav>
                </div>
                <div class="col-auto">
                    <a href="/shop/cart" class="btn btn-outline-light me-2">
                        <i class="bi bi-cart3 me-1"></i>
                        Giỏ Hàng
                        <span class="badge bg-danger ms-1" id="cart-count">0</span>
                    </a>
                    <a href="/shop/products" class="btn btn-outline-light">
                        <i class="bi bi-grid me-1"></i>
                        Sản Phẩm
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Wishlist Stats -->
        <div class="wishlist-stats">
            <div class="row text-center">
                <div class="col-md-4">
                    <h3 class="mb-0" id="totalItems">0</h3>
                    <small>Sản phẩm yêu thích</small>
                </div>
                <div class="col-md-4">
                    <h3 class="mb-0" id="totalValue">0₫</h3>
                    <small>Tổng giá trị</small>
                </div>
                <div class="col-md-4">
                    <h3 class="mb-0" id="availableItems">0</h3>
                    <small>Còn hàng</small>
                </div>
            </div>
        </div>

        <!-- Wishlist Actions -->
        <div class="row mb-4">
            <div class="col-md-6">
                <button class="btn btn-wishlist" onclick="addAllToCart()">
                    <i class="bi bi-cart-plus me-1"></i>
                    Thêm tất cả vào giỏ hàng
                </button>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-outline-light" onclick="clearWishlist()">
                    <i class="bi bi-trash me-1"></i>
                    Xóa tất cả
                </button>
            </div>
        </div>

        <!-- Wishlist Items -->
        <div id="wishlistContainer">
            <!-- Wishlist items will be loaded here -->
        </div>

        <!-- Empty Wishlist Message -->
        <div class="empty-wishlist d-none" id="emptyWishlistMessage">
            <i class="bi bi-heart"></i>
            <h3>Danh sách yêu thích trống</h3>
            <p>Bạn chưa có sản phẩm nào trong danh sách yêu thích.</p>
            <a href="/shop/products" class="btn btn-wishlist">
                <i class="bi bi-grid me-1"></i>
                Khám phá sản phẩm
            </a>
        </div>
    </div>

    <!-- External JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let wishlistItems = [];
        
        // Load wishlist on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadWishlist();
            updateCartCount();
        });
        
        function loadWishlist() {
            fetch('/api/shop/wishlist')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        wishlistItems = data.data;
                        displayWishlist();
                        updateStats();
                    } else {
                        showEmptyWishlist();
                    }
                })
                .catch(error => {
                    console.error('Error loading wishlist:', error);
                    showEmptyWishlist();
                });
        }
        
        function displayWishlist() {
            const container = document.getElementById('wishlistContainer');
            const emptyMessage = document.getElementById('emptyWishlistMessage');
            
            if (!wishlistItems || wishlistItems.length === 0) {
                showEmptyWishlist();
                return;
            }
            
            container.innerHTML = '';
            emptyMessage.classList.add('d-none');
            
            wishlistItems.forEach(item => {
                const wishlistCard = createWishlistCard(item);
                container.appendChild(wishlistCard);
            });
        }
        
        function createWishlistCard(item) {
            const product = item.product;
            const stockStatus = getStockStatus(product.quantity);
            
            const card = document.createElement('div');
            card.className = 'wishlist-card';
            card.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-2">
                        <img src="${product.imageUrl || '/images/no-image.png'}" 
                             alt="${product.productName}" class="product-image">
                    </div>
                    <div class="col-md-4">
                        <h5 class="product-name">${product.productName}</h5>
                        <p class="product-category">
                            <i class="bi bi-tag me-1"></i>
                            ${product.category?.categoryName || 'Không có danh mục'}
                        </p>
                        <span class="stock-status ${stockStatus.class}">${stockStatus.text}</span>
                    </div>
                    <div class="col-md-2">
                        <div class="product-price">${formatPrice(product.price)}</div>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">Thêm vào: ${formatDate(item.addedAt)}</small>
                    </div>
                    <div class="col-md-2 text-end">
                        <button class="btn btn-wishlist btn-sm me-1" 
                                onclick="addToCart(${product.productId})"
                                ${product.quantity <= 0 ? 'disabled' : ''}>
                            <i class="bi bi-cart-plus"></i>
                        </button>
                        <button class="btn btn-remove btn-sm" 
                                onclick="removeFromWishlist(${product.productId})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        function getStockStatus(quantity) {
            if (quantity <= 0) {
                return { class: 'out-stock', text: 'Hết hàng' };
            } else if (quantity <= 10) {
                return { class: 'low-stock', text: `Còn ${quantity} sản phẩm` };
            } else {
                return { class: 'in-stock', text: 'Còn hàng' };
            }
        }
        
        function updateStats() {
            const totalItems = wishlistItems.length;
            const totalValue = wishlistItems.reduce((sum, item) => sum + parseFloat(item.product.price), 0);
            const availableItems = wishlistItems.filter(item => item.product.quantity > 0).length;
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalValue').textContent = formatPrice(totalValue);
            document.getElementById('availableItems').textContent = availableItems;
        }
        
        function showEmptyWishlist() {
            document.getElementById('wishlistContainer').innerHTML = '';
            document.getElementById('emptyWishlistMessage').classList.remove('d-none');
            updateStats();
        }
        
        function removeFromWishlist(productId) {
            if (!confirm('Bạn có chắc muốn xóa sản phẩm này khỏi danh sách yêu thích?')) {
                return;
            }
            
            fetch('/api/shop/wishlist/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `productId=${productId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadWishlist(); // Reload wishlist
                    showToast('Đã xóa sản phẩm khỏi danh sách yêu thích!', 'success');
                } else {
                    showToast(data.message || 'Có lỗi xảy ra!', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Có lỗi xảy ra!', 'error');
            });
        }
        
        function addToCart(productId) {
            const quantity = 1; // Default quantity
            
            fetch('/cart/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `productId=${productId}&quantity=${quantity}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateCartCount();
                    showToast('Đã thêm sản phẩm vào giỏ hàng!', 'success');
                } else {
                    showToast(data.message || 'Có lỗi xảy ra!', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Có lỗi xảy ra!', 'error');
            });
        }
        
        function addAllToCart() {
            const availableProducts = wishlistItems.filter(item => item.product.quantity > 0);
            
            if (availableProducts.length === 0) {
                showToast('Không có sản phẩm nào còn hàng để thêm vào giỏ!', 'warning');
                return;
            }
            
            if (!confirm(`Bạn có muốn thêm ${availableProducts.length} sản phẩm vào giỏ hàng?`)) {
                return;
            }
            
            Promise.all(availableProducts.map(item => 
                fetch('/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `productId=${item.product.productId}&quantity=1`
                })
            ))
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(results => {
                const successCount = results.filter(r => r.success).length;
                updateCartCount();
                showToast(`Đã thêm ${successCount}/${availableProducts.length} sản phẩm vào giỏ hàng!`, 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Có lỗi xảy ra khi thêm sản phẩm!', 'error');
            });
        }
        
        function clearWishlist() {
            if (!confirm('Bạn có chắc muốn xóa tất cả sản phẩm khỏi danh sách yêu thích?')) {
                return;
            }
            
            // Remove all items one by one
            Promise.all(wishlistItems.map(item => 
                fetch('/api/shop/wishlist/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `productId=${item.product.productId}`
                })
            ))
            .then(() => {
                loadWishlist();
                showToast('Đã xóa tất cả sản phẩm khỏi danh sách yêu thích!', 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Có lỗi xảy ra!', 'error');
            });
        }
        
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }
        
        function updateCartCount() {
            fetch('/api/shop/cart')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('cart-count').textContent = data.count || 0;
                    }
                })
                .catch(error => {
                    console.log('Not logged in or error getting cart count');
                });
        }
        
        function showToast(message, type = 'info') {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.parentElement.removeChild(toast);
                }
            }, 5000);
        }
    </script>
</body>
</html>
